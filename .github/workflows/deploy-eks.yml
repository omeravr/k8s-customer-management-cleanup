name: EKS Deployment

on:
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Setup Node.js (Install Node.js)
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1  # Correct repository

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}
          CLUSTER_VERSION: ${{ secrets.CLUSTER_VERSION }}
          VPC_ID: ${{ secrets.VPC_ID }}
          SUBNET_IDS: ${{ secrets.SUBNET_IDS }}
          LB_SUBNET_IDS: ${{ secrets.LB_SUBNET_IDS }}
          INSTANCE_TYPES: ${{ secrets.INSTANCE_TYPES }}
          LB_INTERNAL: ${{ secrets.LB_INTERNAL }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          CLUSTER_NAME: ${{ secrets.CLUSTER_NAME }}
          CLUSTER_VERSION: ${{ secrets.CLUSTER_VERSION }}
          VPC_ID: ${{ secrets.VPC_ID }}
          SUBNET_IDS: ${{ secrets.SUBNET_IDS }}
          LB_SUBNET_IDS: ${{ secrets.LB_SUBNET_IDS }}
          INSTANCE_TYPES: ${{ secrets.INSTANCE_TYPES }}
          LB_INTERNAL: ${{ secrets.LB_INTERNAL }}

      - name: Update kubeconfig for EKS
        run: aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.CLUSTER_NAME }}

      - name: Install AWS Load Balancer Controller
        run: |
          eksctl create iamserviceaccount \
            --cluster ${{ secrets.CLUSTER_NAME }} \
            --namespace kube-system \
            --name aws-load-balancer-controller \
            --attach-policy-arn ${{ secrets.AWS_LBC_POLICY_ARN }} \
            --approve

          helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system \
            --set clusterName=${{ secrets.CLUSTER_NAME }} \
            --set serviceAccount.create=false \
            --set serviceAccount.name=aws-load-balancer-controller \
            --set region=${{ secrets.AWS_REGION }} \
            --set vpcId=${{ secrets.VPC_ID }}

      - name: Deploy NGINX App
        run: |
          kubectl apply -f app/test/nginx-deployment.yaml

      - name: Create TargetGroupBinding for NGINX App
        run: |
          TG_ARN=$(aws elbv2 describe-target-groups --query "TargetGroups[?TargetGroupName=='eks-nlb-tg'].TargetGroupArn" --output text)
          sed -i "s#TARGET_GROUP_ARN_PLACEHOLDER#${TG_ARN}#g" app/test/targetgroupbinding.yaml
          kubectl apply -f app/test/targetgroupbinding.yaml

